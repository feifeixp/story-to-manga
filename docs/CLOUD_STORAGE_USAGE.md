# 云存储功能使用指南

## 🚀 概述

Story to Manga 现在支持云存储功能，让您的漫画项目可以在多个设备间同步，永不丢失。本指南将帮助您了解如何使用云存储功能。

## ✨ 主要功能

### 🔄 混合存储模式
- **本地存储**: 数据保存在浏览器中，快速访问
- **云端存储**: 数据保存在 Cloudflare R2，跨设备同步
- **智能切换**: 根据用户登录状态自动选择存储方式
- **数据备份**: 本地和云端双重保障

### 🔐 用户认证
- **Supabase Auth**: 安全的用户认证系统
- **数据隔离**: 每个用户的数据完全独立
- **权限控制**: 只有用户本人可以访问自己的数据

### 📁 文件组织
```
用户数据结构:
users/{userId}/projects/{projectId}/
├── metadata.json          # 项目元数据
├── story.json            # 故事数据和设置
├── characters/
│   ├── generated/        # AI生成的角色参考图
│   └── uploaded/         # 用户上传的角色参考图
├── settings/
│   └── uploaded/         # 用户上传的场景参考图
└── panels/               # 生成的漫画面板
    └── {panelNumber}.jpg
```

## 🛠️ 设置云存储

### 1. 环境变量配置

在 `.env.local` 文件中添加以下配置：

```bash
# Cloudflare R2 存储配置
R2_ACCESS_KEY_ID=your_r2_access_key_id
R2_SECRET_ACCESS_KEY=your_r2_secret_access_key

# Supabase 配置（如果还没有）
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

### 2. 获取 Cloudflare R2 凭据

1. 登录 [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. 进入 R2 Object Storage
3. 创建或选择存储桶 `mangashare`
4. 生成 API 令牌：
   - 进入 "Manage R2 API Tokens"
   - 创建新的 API 令牌
   - 权限设置为 "Object Read and Write"
   - 复制 Access Key ID 和 Secret Access Key

### 3. 测试连接

运行测试脚本验证配置：

```bash
# 设置环境变量
export R2_ACCESS_KEY_ID=your_access_key_id
export R2_SECRET_ACCESS_KEY=your_secret_access_key

# 运行测试
node tests/test-cloud-storage.js
```

## 📱 用户使用流程

### 1. 首次使用（本地模式）

- 用户可以直接开始创建漫画项目
- 数据自动保存在浏览器本地存储中
- 无需注册即可使用所有功能

### 2. 启用云存储

#### 方式一：通过云存储管理页面
1. 访问 `/cloud-storage` 页面
2. 点击"登录账户"或"注册账户"
3. 完成认证后，系统会自动检测本地数据
4. 选择"开始迁移"将本地数据同步到云端

#### 方式二：在应用中注册/登录
1. 在主应用页面点击用户头像
2. 选择"登录"或"注册"
3. 完成认证后，系统会提示是否同步本地数据

### 3. 数据同步

#### 自动同步
- 用户登录后，所有项目操作会自动同步到云端
- 本地数据作为备份保留
- 网络异常时自动降级到本地存储

#### 手动同步
- 访问云存储管理页面
- 点击"同步到云端"按钮
- 查看同步进度和结果

### 4. 跨设备访问

1. 在新设备上访问应用
2. 使用相同账户登录
3. 云端数据会自动加载到新设备
4. 可以继续编辑和创建项目

## 🔧 技术特性

### 性能优化
- **图像压缩**: 自动优化图片大小和质量
- **增量同步**: 只同步变更的数据
- **预签名URL**: 大文件直接上传，减少服务器负载
- **缓存策略**: 智能缓存提升访问速度

### 安全保障
- **数据加密**: 所有数据在传输和存储时都经过加密
- **访问控制**: 基于JWT的用户身份验证
- **权限验证**: 每次操作都验证用户权限
- **数据隔离**: 用户数据完全隔离，无法互相访问

### 错误处理
- **网络异常**: 自动重试和降级处理
- **存储失败**: 本地备份确保数据不丢失
- **认证过期**: 自动刷新令牌或提示重新登录
- **冲突解决**: 智能合并本地和云端数据

## 🚨 故障排除

### 常见问题

#### 1. 无法连接到云存储
- 检查网络连接
- 验证 R2 凭据是否正确
- 确认 R2 存储桶权限设置

#### 2. 同步失败
- 检查用户认证状态
- 查看浏览器控制台错误信息
- 尝试手动同步

#### 3. 数据不一致
- 使用云存储管理页面的"重新同步"功能
- 检查本地和云端数据的时间戳
- 必要时可以选择强制覆盖

### 调试工具

#### 1. 云存储测试页面
访问 `/debug-share` 页面查看：
- 数据库连接状态
- 项目数据完整性
- 图片加载情况

#### 2. 浏览器开发者工具
- Network 标签：查看API请求状态
- Console 标签：查看错误日志
- Application 标签：检查本地存储数据

#### 3. 服务器日志
检查应用日志中的云存储相关信息：
- 上传/下载操作
- 认证状态
- 错误详情

## 📊 监控和维护

### 存储使用情况
- 在云存储管理页面查看存储统计
- 监控项目数量和数据大小
- 定期清理不需要的项目

### 性能监控
- 关注同步速度和成功率
- 监控API响应时间
- 跟踪用户使用模式

### 数据备份
- 云端数据自动备份到多个区域
- 本地数据作为额外备份
- 定期导出重要项目数据

## 🔮 未来规划

### 即将推出的功能
- **协作功能**: 多用户协作编辑项目
- **版本控制**: 项目历史版本管理
- **批量操作**: 批量导入/导出项目
- **高级分析**: 使用统计和性能分析

### 性能改进
- **CDN加速**: 全球内容分发网络
- **智能预加载**: 预测性数据加载
- **离线支持**: 完整的离线工作模式
- **实时同步**: WebSocket实时数据同步

---

## 📞 技术支持

如果您在使用云存储功能时遇到问题，请：

1. 查看本文档的故障排除部分
2. 检查 GitHub Issues 中的相关问题
3. 提交新的 Issue 并提供详细信息：
   - 错误信息和截图
   - 浏览器和操作系统信息
   - 复现步骤

我们会尽快为您提供帮助！🚀
